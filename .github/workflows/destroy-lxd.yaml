name: Destroy LXD Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm (case sensitive)'
        required: true
        type: string
      target_vms:
        description: "Which VMs to destroy (optional - destroys all if empty)"
        required: false
        type: choice
        options:
          - all
          - prod-only
          - stg-only
          - dev-only

jobs:
  validate:
    runs-on: [self-hosted, host]
    outputs:
      should_proceed: ${{ steps.validation.outputs.should_proceed }}
    steps:
      - name: Validate confirmation
        id: validation
        run: |
          if [[ "${{ github.event.inputs.confirm_destroy }}" == "DESTROY" ]]; then
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "âœ… Confirmation validated"
          else
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            echo "âŒ Invalid confirmation. You must type 'DESTROY' exactly."
            exit 1
          fi

  destroy:
    needs: validate
    runs-on: self-hosted
    if: needs.validate.outputs.should_proceed == 'true'
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # Terraform Cloudì— ë¡œê·¸ì¸í•˜ê¸° ìœ„í•œ ì„¤ì •
      - name: Configure Terraform Cloud credentials
        run: |
          cat > ~/.terraformrc <<EOF
          credentials "app.terraform.io" {
          token = "${{ secrets.TF_API_TOKEN_BANNOTE_SERVER }}"
          }
          EOF

      - name: Check LXD availability
        run: |
          echo "Checking if LXD is available..."
          if ! command -v lxc &> /dev/null; then
            echo "âŒ LXD command not found. Please install LXD."
            exit 1
          fi

          echo "Testing LXD access..."
          if ! lxc_output=$(lxc version 2>&1); then
            echo "âŒ LXD is not accessible. See error below:"
            echo "$lxc_output"
            exit 1
          fi

          echo "âœ… LXD is available."
          echo "$lxc_output"

      - name: Set environment variables
        run: |
          # Determine ENV from branch name
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV=main" >> $GITHUB_ENV
            echo "WORKSPACE_NAME=bannote-server-main" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "ENV=dev" >> $GITHUB_ENV
            echo "WORKSPACE_NAME=bannote-server-dev" >> $GITHUB_ENV
          else
            echo "Error: Destroy workflow must be run from 'main' or 'dev' branch."
            exit 1
          fi
          echo "TARGET_VMS=${{ github.event.inputs.target_vms }}" >> $GITHUB_ENV

      - name: Show what will be destroyed
        run: |
          echo "ðŸ”¥ About to destroy the following:"
          echo "Environment: ${{ env.ENV }}"
          echo "Target VMs: ${{ env.TARGET_VMS }}"
          echo ""
          echo "This will destroy:"
          if [[ "${{ env.TARGET_VMS }}" == "all" || "${{ env.TARGET_VMS }}" == "" ]]; then
            echo "- bannote-${{ env.ENV }}-prod"
            echo "- bannote-${{ env.ENV }}-stg"
            echo "- bannote-${{ env.ENV }}-dev"
          elif [[ "${{ env.TARGET_VMS }}" == "prod-only" ]]; then
            echo "- bannote-${{ env.ENV }}-prod"
          elif [[ "${{ env.TARGET_VMS }}" == "stg-only" ]]; then
            echo "- bannote-${{ env.ENV }}-stg"
          elif [[ "${{ env.TARGET_VMS }}" == "dev-only" ]]; then
            echo "- bannote-${{ env.ENV }}-dev"
          fi

      - name: Terraform Init
        working-directory: ./lxd-infra
        env:
          TF_INPUT: false
          TF_CLI_ARGS: "-no-color"
        run: |
          echo "Using Terraform workspace: ${{ env.WORKSPACE_NAME }}"
          export TF_WORKSPACE=${{ env.WORKSPACE_NAME }}
          terraform init

      - name: List current resources
        working-directory: ./lxd-infra
        env:
          TF_INPUT: false
        run: |
          echo "ðŸ“‹ Current Terraform state:"
          export TF_WORKSPACE=${{ env.WORKSPACE_NAME }}
          terraform show -no-color || echo "No state file found"

      - name: Selective Destroy
        working-directory: ./lxd-infra
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_INPUT: false
          TF_CLI_ARGS: "-no-color"
        run: |
          export TF_WORKSPACE=${{ env.WORKSPACE_NAME }}

          if [[ "${{ env.TARGET_VMS }}" == "all" || "${{ env.TARGET_VMS }}" == "" ]]; then
            echo "ðŸ”¥ Destroying all VMs for environment: ${{ env.ENV }}"
            terraform destroy -auto-approve -var="environment=${{ env.ENV }}"
          else
            echo "ðŸ”¥ Destroying specific VMs: ${{ env.TARGET_VMS }}"
            case "${{ env.TARGET_VMS }}" in
              "prod-only")
                terraform destroy -auto-approve -target="lxd_instance.cluster_vms[\"bannote-${{ env.ENV }}-prod\"]" -var="environment=${{ env.ENV }}"
                ;;
              "stg-only")
                terraform destroy -auto-approve -target="lxd_instance.cluster_vms[\"bannote-${{ env.ENV }}-stg\"]" -var="environment=${{ env.ENV }}"
                ;;
              "dev-only")
                terraform destroy -auto-approve -target="lxd_instance.cluster_vms[\"bannote-${{ env.ENV }}-dev\"]" -var="environment=${{ env.ENV }}"
                ;;
            esac
          fi

      - name: Verify destruction
        working-directory: ./lxd-infra
        env:
          TF_INPUT: false
        run: |
          echo "âœ… Destruction completed. Current state:"
          export TF_WORKSPACE=${{ env.WORKSPACE_NAME }}
          terraform show -no-color || echo "No resources remaining"

      - name: Cleanup notification
        run: |
          echo "ðŸŽ‰ Infrastructure cleanup completed!"
          echo "Environment: ${{ env.ENV }}"
          echo "Destroyed: ${{ env.TARGET_VMS }}"
          echo "Timestamp: $(date)"
